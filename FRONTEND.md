# Инструкция для фронта (мини)

Базовый URL API: `https://твой-бэкенд.up.railway.app` (или `http://localhost:3000`).

**Реферальная система (Telegram-бот):** см. **[BOT_REFERRAL.md](./BOT_REFERRAL.md)** — пошагово для разработчика бота: ссылка, регистрация с ref, когда начисляются баллы.

---

## 1. Пользователь без QR (вводит код клуба)

- На экране поле: **«Введите 6-значный код клуба»** (код виден на стенде/экране клуба).
- Пользователь вводит, например, `482917`.

**Получить данные клуба (название и т.д.):**
- **GET** `/api/players/club?club=482917`  
- Ответ: `{ _id, name, clubId, qrToken, pinCode }`

**Список призов рулетки:**
- **GET** `/api/players/roulette-prizes`  
- Ответ: массив призов (`name`, `image`, `slotIndex`, `type`, `value` и т.д.)

**Крутить рулетку (по телефону, без токена):**
- **POST** `/api/players/spin-by-phone`  
- Тело (достаточно геолокации + телефон, код клуба не обязателен):  
  `{ "phone": "79991234567", "latitude": 43.23896, "longitude": 76.94547 }`  
  Опционально можно передать `clubId` (6 цифр или qrToken) — тогда проверяется, что пользователь в радиусе 200 м от этого клуба.
- Бэкенд по гео находит **ближайший клуб в радиусе 200 м** и крутит спин по нему.
- Ответ: `{ spin: { _id, prize: { name, image, slotIndex, ... }, playerPhone }, newBalance }`  
- Ошибки: `400` — «Передайте latitude и longitude» / «Вы не в радиусе ни одного клуба (в пределах 200 м)» / мало баллов; `404` — пользователь не найден.

Итого: пользователь даёт **геолокацию** и **телефон** → спин крутится по ближайшему клубу в 200 м. Код клуба вводить не обязательно.

---

## 2. Экран клуба (телевизор/стенд)

Экран показывает рулетку и ленту «кто выиграл». Подключение к сокету по клубу (по `_id`, `clubId`, `qrToken` или **6-значному коду**).

**Подключение к сокету:**
- Тот же хост, что и API (WebSocket).
- При подключении передать в query: `clubId` = один из: Mongo `_id` клуба, строка `clubId`, `qrToken` или **6 цифр** (`pinCode`).
- Пример: `io(API_URL, { query: { clubId: "482917" }, transports: ["polling", "websocket"] })`.

**Событие от сервера:**
- `spin` — при каждом новом спине в этом клубе.
- Payload: `{ _id, prize: { name, image, slotIndex, ... }, playerPhone, recentWins: [ { text: "+7 771 *** 3738 выиграл 100 баллов", ... }, ... ] }`.
- Действия на фронте: запустить анимацию рулетки по `prize`, обновить ленту выигрышей из `recentWins` (или только `recentWins[].text`).

**Последние 10 выигрышей по всем клубам (при загрузке экрана):**
- **GET** `/api/players/recent-wins` (без параметров).
- Ответ: массив до 10 элементов: `[ { maskedPhone, prizeName, text: "+7 771 *** 3738 выиграл Приз" }, ... ]`.

---

## 3. Кратко по эндпоинтам

| Что нужно | Метод | URL | Тело / параметры |
|-----------|--------|-----|-------------------|
| Данные клуба по коду/QR | GET | `/api/players/club?club=482917` | — |
| Призы рулетки | GET | `/api/players/roulette-prizes` | — |
| Крутить по телефону | POST | `/api/players/spin-by-phone` | `{ "phone": "79991234567", "latitude": 43.24, "longitude": 76.95 }` (clubId не обязателен) |
| Последние 10 выигрышей | GET | `/api/players/recent-wins` | — |
| Сокет (экран клуба) | — | тот же хост | query: `clubId=482917` (или _id / qrToken), слушать событие `spin` |

Везде, где указывается клуб, можно передавать **6-значный код** (`pinCode`), `clubId`, `qrToken` или Mongo `_id` клуба.
